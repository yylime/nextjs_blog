---
title: "åœ¨pythonä¸­ä½¿ç”¨rustæ¯”å¯¹äº¤æ¢æœºé…ç½®"
description: "æœ€è¿‘åœ¨pythonä¸­ä½¿ç”¨äº†æ–‡æœ¬å¯¹æ¯”å¤„ç†äº¤æ¢æœºé…ç½®ï¼Œä½†æ˜¯äº¤æ¢æœºæ•°é‡å¾ˆå¤šæ•ˆæœä¸ç†æƒ³ï¼Œäºæ˜¯æ‰“ç®—é€šè¿‡rustæ¥æé«˜æ€§èƒ½"
image: Rust-python.png
publishedAt: 2025-04-30 16:10:00
updatedAt: 2025-04-30 16:10:00
author: "yylime"
isPublished: true
tags:
- rust
slug: use-rust-in-python-text-diff
---

æœ€è¿‘åœ¨pythonä¸­ä½¿ç”¨äº†æ–‡æœ¬å¯¹æ¯”å¤„ç†äº¤æ¢æœºé…ç½®ä»¥å¾—åˆ°ä¸åŒæ—¶é—´å†…é…ç½®å˜æ›´çš„æ•°é‡ç”¨äºå›æŠ¥ã€‚å½“å‰ç³»ç»Ÿå†…äº¤æ¢æœºæ•°é‡ç°åœ¨åˆ°äº†2000+ï¼Œéƒ¨åˆ†ACå’Œæ ¸å¿ƒçš„é…ç½®è¡Œæ•°éƒ½åˆ°äº†ä¸‡çº§åˆ«çš„ï¼Œè¿™å¯¼è‡´æ¯æ¬¡æŸ¥è¯¢é…ç½®å˜æ›´è¡Œå˜å¾—æ„ˆå‘ç¼“æ…¢ï¼Œäºæ˜¯æ‰“ç®—ä½¿ç”¨rusté‡æ„æ–‡æœ¬å·®å¼‚å‡½æ•°ï¼Œå¹¶å¯ä»¥ç›´æ¥åœ¨pythonä¸­è°ƒç”¨è¯¥å‡½æ•°ã€‚

> python ç‰ˆæœ¬çš„é…ç½®å˜æ›´æ•°é‡è®¡ç®—

```python showLineNumbers
# python ç‰ˆæœ¬3.6
def compare_config_count(cfg_pre, cfg_cur):
    total_changes = 0
    ignores = ["clock-period", "!Time", "time", "Running configuration", "	", "Current configuration", "Last configuration", "snmp-agent target-host host-name"]
    withouts = ["Last configuration", "Generated by", "Size is", "create-time", "File Signature", "Date", "snmp-agent community", "password encrypted-password", "password"]
    ignores += withouts
    if cfg_pre and cfg_cur:
        cfg_pre, cfg_cur = cfg_pre.split("\n"), cfg_cur.split("\n")
        cfg_pre, cfg_cur = [
            line
            for line in cfg_pre
            if not any([ig in line for ig in ignores]) and len(line) > 3
        ], [
            line
            for line in cfg_cur
            if not any([ig in line for ig in ignores]) and len(line) > 3
        ]
        cfg_pre, cfg_cur = [line.strip() for line in cfg_pre], [
            line.strip() for line in cfg_cur
        ]
        diff = difflib.ndiff(cfg_pre, cfg_cur)
        total_changes = sum(1 for line in diff if line.startswith(('+ ', '- ')))
    return total_changes
```

## ä½¿ç”¨pyo3å°†rustå‡½æ•°è½¬ä¸ºpythonå¯è°ƒç”¨å‡½æ•°
[é¡¹ç›®åœ°å€](https://pyo3.rs/v0.24.2/changelog.html)ï¼Œæ³¨æ„åˆ°å…¶æœ€æ–°ç‰ˆæœ¬ï¼ˆv0.24.2ï¼‰æ”¯æŒæ˜¯ä»3.7å¼€å§‹çš„ã€‚å¦‚æœä½ æƒ³å’Œæˆ‘ä¸€æ ·åœ¨python3.6ä¸­ä½¿ç”¨ï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨pyo3 0.15.2
> PyO3 supports the following Python distributions:
> CPython 3.7 or greater
> PyPy 7.3 (Python 3.9+)
> GraalPy 24.0 or greater (Python 3.10+)

### åˆ›å»ºé¡¹ç›®
```bash
cargo new --lib rust_diff
cd rust_diff
```
### æ·»åŠ ä¾èµ–åº“
è¿™é‡Œç›´æ¥å‚è€ƒå®˜æ–¹çš„å®ç°å°±å¯ä»¥äº†ï¼Œå®˜æ–¹æ–‡æ¡£ç»™å‡ºçš„æ­¥éª¤éå¸¸çš„ç®€å•ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„åå­—å’Œä¸‹é¢çš„`src/lib.rs`ä¸­çš„ä¿æŒä¸€è‡´ï¼Œå®˜æ–¹æ–‡æ¡£ä¸­çš„è¦æ±‚å¦‚æ­¤ã€‚
```toml showLineNumbers {5}
[lib]
# The name of the native library. This is the name which will be used in Python to import the
# library (i.e. `import string_sum`). If you change this, you must also change the name of the
# `#[pymodule]` in `src/lib.rs`.
name = "rustpy"
path = "src/lib.rs"
crate-type = ["cdylib"]

[dependencies]
pyo3 = { version = "0.15.2", features = ["extension-module"] }
similar = "2.7.0"
```
### å®ç°åŠŸèƒ½
å‚è€ƒä¸Šè¿°çš„`python`ä»£ç åœ¨`src/lib.rs`ä¸­å®ç°å¦‚ä¸‹ä»£ç ã€‚å¹¶ä½¿ç”¨`cargo test`è¿›è¡Œæµ‹è¯•ï¼Œç¡®ä¿å‡½æ•°åŠŸèƒ½æ­£å¸¸ã€‚

```rust showLineNumbers title="src/lib.rs"
use pyo3::prelude::*;
use similar::{ChangeTag, TextDiff};


#[pyfunction]
pub fn compare_config_count(cfg_pre: &str, cfg_cur: &str) -> usize {
    let ignores = vec![
        "clock-period", "!Time", "time", "Running configuration", "	", 
        "Current configuration", "Last configuration", "snmp-agent target-host host-name",
        "Generated by", "Size is", "create-time", "File Signature", "Date",
        "snmp-agent community", "password encrypted-password", "password"
    ];

    // Pre-process the configurations
    let cfg_pre_lines: Vec<&str> = cfg_pre.lines()
        .filter(|line| !ignores.iter().any(|ignore| line.contains(ignore)) && line.trim().len() > 3)
        .map(|line| line.trim())
        .collect();

    let cfg_cur_lines: Vec<&str> = cfg_cur.lines()
        .filter(|line| !ignores.iter().any(|ignore| line.contains(ignore)) && line.trim().len() > 3)
        .map(|line| line.trim())
        .collect();

    // Join them back as strings with newlines (to use text_diff)
    let cfg_pre_filtered = cfg_pre_lines.join("\n") + "\n";
    let cfg_cur_filtered = cfg_cur_lines.join("\n") + "\n";


    // Use similar's TextDiff to compute changes efficiently
    let diff = TextDiff::from_lines(&cfg_pre_filtered, &cfg_cur_filtered);

    // Count number of changed lines (insertions or deletions)
    let mut change_count = 0;

    for change in diff.iter_all_changes() {
        match change.tag() {
            ChangeTag::Delete | ChangeTag::Insert => change_count += 1,
            ChangeTag::Equal => (),
        };
    }

    change_count
}

// å®ç°çš„å‡½æ•°å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
#[pymodule]
fn rustpy(py: Python, m: &PyModule) -> PyResult<()> {
    m.add_function(wrap_pyfunction!(compare_config_count, m)?)?;
    Ok(())
}


#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_compare_config_count() {
        let pre = "interface GigabitEthernet0/0\n ip address 192.168.1.1 255.255.255.0\n!\ntime\n snmp-agent community read public";
        let cur = "interface GigabitEthernet0/0\n time\n!";

        let changes = compare_config_count(pre, cur); // è¿”å› 1ï¼Œä»… ip åœ°å€å˜åŒ–
        assert_eq!(changes, 1); // æ ¹æ®é€»è¾‘ï¼Œé¢„æœŸçš„å˜åŒ–æ•°ä¸º 3
    }
}
```

### ç¼–è¯‘ä¸ºpythonæ¨¡å—
æˆ‘æœ¬åœ°çš„ç¯å¢ƒç”¨çš„æ˜¯minicondaï¼Œè¿™é‡Œéœ€è¦å®‰è£…`maturin`ï¼Œå®ƒå¯ä»¥é…åˆpo3ç›´æ¥å°†rusté¡¹ç›®ä¸­çš„å‡½æ•°ä½œä¸ºåº“å®‰è£…åˆ°å½“å‰ç¯å¢ƒä¸­ã€‚
```bash
# ç¡®ä¿åœ¨condaçš„ç¯å¢ƒä¸‹æ‰§è¡Œ
pip install maturin
```
æ‰“åŒ…æµ‹è¯•
```bash
maturin develop
```
åœ¨pythonä¸­è°ƒç”¨æµ‹è¯•
```python
from rustpy import compare_config_count
print(compare_config_count(pre, cur))
```
### ä¼˜åŒ–æ‰“åŒ…åçš„ç¨‹åº
é»˜è®¤æƒ…å†µä¸‹ä¸åŠ **--release**å‚æ•°ï¼Œæ‰“åŒ…åæ–‡ä»¶ä¼šæ¯”è¾ƒå¤§ï¼Œå¹¶ä¸”æ‰§è¡Œæ…¢ã€‚åœ¨æ‰“åŒ…æ—¶ï¼Œå¯ä»¥æŒ‡å®šä¸€äº›å‚æ•°ï¼Œä½¿å¾—æ‰“åŒ…åçš„å‚æ•°æ›´åŠ è½»é‡ã€‚
```bash
maturin develop --release --strip
```

- ğŸ” å‘½ä»¤åŠŸèƒ½å¯¹æ¯”

| å‘½ä»¤ | æ¨¡å¼ | æ˜¯å¦ä¼˜åŒ– | æ˜¯å¦å»é™¤è°ƒè¯•ç¬¦å· | æ˜¯å¦é€‚åˆç”Ÿäº§æµ‹è¯• |
|------|------|-----------|------------------|-------------------|
| `maturin develop` | debug æ¨¡å¼ | âŒ ä¸ä¼˜åŒ– | âœ… å«è°ƒè¯•ä¿¡æ¯ | âŒ ä¸é€‚åˆç”Ÿäº§æ€§èƒ½æµ‹è¯• |
| `maturin develop --release` | release æ¨¡å¼ | âœ… é«˜åº¦ä¼˜åŒ– | âœ… å«è°ƒè¯•ç¬¦å·ï¼ˆé»˜è®¤ï¼‰ | âœ… æ›´æ¥è¿‘å®é™…å‘å¸ƒæ•ˆæœ |
| `maturin develop --release --strip` | release æ¨¡å¼ | âœ… é«˜åº¦ä¼˜åŒ– | âœ… å»é™¤è°ƒè¯•ç¬¦å·ï¼ˆæ›´å°ï¼‰ | âœ… æ›´è´´è¿‘æœ€ç»ˆå‘å¸ƒç‰ˆæœ¬ |


-  âœ… å°æŠ€å·§ï¼šä½ å¯ä»¥åœ¨ `pyproject.toml` ä¸­ç»Ÿä¸€é…ç½®è¿™äº›é€‰é¡¹
```toml
[tool.maturin]
release = true
strip = true
```
è¿™æ ·æ‰€æœ‰çš„ `develop` å’Œ `build` å‘½ä»¤éƒ½ä¼šé»˜è®¤å¯ç”¨è¿™äº›å‚æ•°ã€‚