---
title: "在python中使用rust比对交换机配置"
description: "最近在python中使用了文本对比处理交换机配置，但是交换机数量很多效果不理想，于是打算通过rust来提高性能"
image: Rust-python.png
publishedAt: 2025-04-30 16:10:00
updatedAt: 2025-04-30 16:10:00
author: "yylime"
isPublished: true
tags:
- rust
slug: use-rust-in-python-text-diff
---

最近在python中使用了文本对比处理交换机配置以得到不同时间内配置变更的数量用于回报。当前系统内交换机数量现在到了2000+，部分AC和核心的配置行数都到了万级别的，这导致每次查询配置变更行变得愈发缓慢，于是打算使用rust重构文本差异函数，并可以直接在python中调用该函数。

> python 版本的配置变更数量计算

```python showLineNumbers
# python 版本3.6
def compare_config_count(cfg_pre, cfg_cur):
    total_changes = 0
    ignores = ["clock-period", "!Time", "time", "Running configuration", "	", "Current configuration", "Last configuration", "snmp-agent target-host host-name"]
    withouts = ["Last configuration", "Generated by", "Size is", "create-time", "File Signature", "Date", "snmp-agent community", "password encrypted-password", "password"]
    ignores += withouts
    if cfg_pre and cfg_cur:
        cfg_pre, cfg_cur = cfg_pre.split("\n"), cfg_cur.split("\n")
        cfg_pre, cfg_cur = [
            line
            for line in cfg_pre
            if not any([ig in line for ig in ignores]) and len(line) > 3
        ], [
            line
            for line in cfg_cur
            if not any([ig in line for ig in ignores]) and len(line) > 3
        ]
        cfg_pre, cfg_cur = [line.strip() for line in cfg_pre], [
            line.strip() for line in cfg_cur
        ]
        diff = difflib.ndiff(cfg_pre, cfg_cur)
        total_changes = sum(1 for line in diff if line.startswith(('+ ', '- ')))
    return total_changes
```

## 使用pyo3将rust函数转为python可调用函数
[项目地址](https://pyo3.rs/v0.24.2/changelog.html)，注意到其最新版本（v0.24.2）支持是从3.7开始的。如果你想和我一样在python3.6中使用，那么需要使用pyo3 0.15.2
> PyO3 supports the following Python distributions:
> CPython 3.7 or greater
> PyPy 7.3 (Python 3.9+)
> GraalPy 24.0 or greater (Python 3.10+)

### 创建项目
```bash
cargo new --lib rust_diff
cd rust_diff
```
### 添加依赖库
这里直接参考官方的实现就可以了，官方文档给出的步骤非常的简单。需要注意的是这里的名字和下面的`src/lib.rs`中的保持一致，官方文档中的要求如此。
```toml showLineNumbers {5}
[lib]
# The name of the native library. This is the name which will be used in Python to import the
# library (i.e. `import string_sum`). If you change this, you must also change the name of the
# `#[pymodule]` in `src/lib.rs`.
name = "rustpy"
path = "src/lib.rs"
crate-type = ["cdylib"]

[dependencies]
pyo3 = { version = "0.15.2", features = ["extension-module"] }
similar = "2.7.0"
```
### 实现功能
参考上述的`python`代码在`src/lib.rs`中实现如下代码。并使用`cargo test`进行测试，确保函数功能正常。

```rust showLineNumbers title="src/lib.rs"
use pyo3::prelude::*;
use similar::{ChangeTag, TextDiff};


#[pyfunction]
pub fn compare_config_count(cfg_pre: &str, cfg_cur: &str) -> usize {
    let ignores = vec![
        "clock-period", "!Time", "time", "Running configuration", "	", 
        "Current configuration", "Last configuration", "snmp-agent target-host host-name",
        "Generated by", "Size is", "create-time", "File Signature", "Date",
        "snmp-agent community", "password encrypted-password", "password"
    ];

    // Pre-process the configurations
    let cfg_pre_lines: Vec<&str> = cfg_pre.lines()
        .filter(|line| !ignores.iter().any(|ignore| line.contains(ignore)) && line.trim().len() > 3)
        .map(|line| line.trim())
        .collect();

    let cfg_cur_lines: Vec<&str> = cfg_cur.lines()
        .filter(|line| !ignores.iter().any(|ignore| line.contains(ignore)) && line.trim().len() > 3)
        .map(|line| line.trim())
        .collect();

    // Join them back as strings with newlines (to use text_diff)
    let cfg_pre_filtered = cfg_pre_lines.join("\n") + "\n";
    let cfg_cur_filtered = cfg_cur_lines.join("\n") + "\n";


    // Use similar's TextDiff to compute changes efficiently
    let diff = TextDiff::from_lines(&cfg_pre_filtered, &cfg_cur_filtered);

    // Count number of changed lines (insertions or deletions)
    let mut change_count = 0;

    for change in diff.iter_all_changes() {
        match change.tag() {
            ChangeTag::Delete | ChangeTag::Insert => change_count += 1,
            ChangeTag::Equal => (),
        };
    }

    change_count
}

// 实现的函数可以在这里添加
#[pymodule]
fn rustpy(py: Python, m: &PyModule) -> PyResult<()> {
    m.add_function(wrap_pyfunction!(compare_config_count, m)?)?;
    Ok(())
}


#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_compare_config_count() {
        let pre = "interface GigabitEthernet0/0\n ip address 192.168.1.1 255.255.255.0\n!\ntime\n snmp-agent community read public";
        let cur = "interface GigabitEthernet0/0\n time\n!";

        let changes = compare_config_count(pre, cur); // 返回 1，仅 ip 地址变化
        assert_eq!(changes, 1); // 根据逻辑，预期的变化数为 3
    }
}
```

### 编译为python模块
我本地的环境用的是miniconda，这里需要安装`maturin`，它可以配合po3直接将rust项目中的函数作为库安装到当前环境中。
```bash
# 确保在conda的环境下执行
pip install maturin
```
打包测试
```bash
maturin develop
```
在python中调用测试
```python
from rustpy import compare_config_count
print(compare_config_count(pre, cur))
```
### 优化打包后的程序
默认情况下不加**--release**参数，打包后文件会比较大，并且执行慢。在打包时，可以指定一些参数，使得打包后的参数更加轻量。
```bash
maturin develop --release --strip
```

- 🔍 命令功能对比

| 命令 | 模式 | 是否优化 | 是否去除调试符号 | 是否适合生产测试 |
|------|------|-----------|------------------|-------------------|
| `maturin develop` | debug 模式 | ❌ 不优化 | ✅ 含调试信息 | ❌ 不适合生产性能测试 |
| `maturin develop --release` | release 模式 | ✅ 高度优化 | ✅ 含调试符号（默认） | ✅ 更接近实际发布效果 |
| `maturin develop --release --strip` | release 模式 | ✅ 高度优化 | ✅ 去除调试符号（更小） | ✅ 更贴近最终发布版本 |


-  ✅ 小技巧：你可以在 `pyproject.toml` 中统一配置这些选项
```toml
[tool.maturin]
release = true
strip = true
```
这样所有的 `develop` 和 `build` 命令都会默认启用这些参数。